var MODULE="LFIB4";
(function(a){function g(){var a=4022871197,d=function(h){for(var h=h.toString(),c=0;c<h.length;c++){a+=h.charCodeAt(c);var d=0.02519603282416938*a;a=d>>>0;d-=a;d*=a;a=d>>>0;d-=a;a+=4294967296*d}return 2.3283064365386963E-10*(a>>>0)};d.version="Mash 0.9";return d}a.LFIB4=function(){return function(a){var d=0,h=58,c=119,m=178,e=[],k=g();0===a.length&&(a=[+new Date]);for(var l=0;256>l;l++)e[l]=k(" "),e[l]-=4.76837158203125E-7*k(" "),0>e[l]&&(e[l]+=1);for(var f=0;f<a.length;f++)for(l=0;256>l;l++)e[l]-=
k(a[f]),e[l]-=4.76837158203125E-7*k(a[f]),0>e[l]&&(e[l]+=1);var k=null,i=function(){var a;d=d+1&255;h=h+1&255;c=c+1&255;m=m+1&255;a=e[d]-e[h];0>a&&(a+=1);a-=e[c];0>a&&(a+=1);a-=e[m];0>a&&(a+=1);return e[d]=a};i.uint32=function(){return 4294967296*i()>>>0};i.fract53=i;i.version="LFIB4 0.9";i.args=a;return i}(Array.prototype.slice.call(arguments))}})("undefined"===typeof exports?this[MODULE]={}:exports);MODULE="util";
(function(a){var g=this.THREE||require("../THREE"),b=g.Vector3,d=g.Quaternion;a.TWOPI=2*Math.PI;a.PULLTOWARD=function(a,c,b){return c+(a-c)/(1+b)};a.MOVETOWARD=function(a,c,b){var e;return c<(e=a-b)?e:c>(e=a+b)?e:c};a.INTERP=function(a,b,d){return a+(b-a)*d};a.CLAMP=function(a,b,d){return Math.min(Math.max(a,b),d)};a.Vec3FromArray=function(a){return new b(a[0],a[1],a[2])};a.QuatFromEuler=function(a){var c=new d;c.setFromAxisAngle(new b(1,0,0),a.x);c.multiplySelf((new d).setFromAxisAngle(new b(0,1,
0),a.y));c.multiplySelf((new d).setFromAxisAngle(new b(0,0,1),a.z));return c};a.KEYCODE={SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40};(function(){for(var b=48;127>b;++b)a.KEYCODE[String.fromCharCode(b)]=b})();a.CallbackQueue=function(a){this.callbacks=[];a&&this.callbacks.push(a)};a.CallbackQueue.prototype.add=function(a){this.callbacks.push(a)};a.CallbackQueue.prototype.fire=function(){for(var a=0;a<this.callbacks.length;++a)this.callbacks[a].apply(void 0,arguments)};a.arraySlice=Function.prototype.call.bind(Array.prototype.slice)})("undefined"===
typeof exports?this[MODULE]={}:exports);MODULE="pubsub";(function(a){var g=this.util||require("./util");a.PubSub=function(){this.handlers=[]};a.PubSub.prototype.subscribe=function(a,d){(this.handlers[a]||(this.handlers[a]=[])).push(d)};a.PubSub.prototype.publish=function(a){(a=this.handlers[a])&&a.forEach(function(a){a.apply(null,g.arraySlice(arguments,1))})}})("undefined"===typeof exports?this[MODULE]={}:exports);MODULE="recorder";
(function(a){function g(a,e){var f={},i;for(i in a)if(aVal=a[i],c.isArray(aVal))f[i]=a[i];else if("object"===typeof aVal){var b=g(aVal,e[i]);c.isEmpty(b)||(f[i]=b)}else aVal!==e[i]&&(f[i]=aVal);return f}function b(a,e,f){if(c.isArray(e))return e.forEach(function(e,c){a[c]=b(a[c],e,f)}),a;return"object"===typeof e?(c.each(e,function(e,c){a[f[c]]=b(a[f[c]],e,f)}),a):parseFloat(e)}function d(a){function e(a){c.each(a,function(a,b){b in f||(f[b]=(i++).toString(36));c.isArray(a)?e(a[0]):"object"===typeof a&&
e(a)})}var f={},i=0;e(a);return f}function h(a,e){if(c.isArray(a)){var f=[];a.forEach(function(a){f.push(h(a,e))});return f}return"object"===typeof a?(f={},c.each(a,function(a,b){f[e[b]]=h(a,e)}),f):a}var c=this._||require("underscore"),m=this.pubsub||require("./pubsub");a.StateRecorder=function(a,e,f){this.timeline=[];this.keys=e;this.keyMap=d(e);this.index=this.freqCount=0;this.freq=f;this.object=a;this.lastDiff=this.lastState=null};a.StateRecorder.prototype.observe=function(){if(this.freq){if(++this.freqCount!=
this.freq)return;this.freqCount=0}var a=e(this.object,this.keys);if(this.lastState){var b=g(a,this.lastState);c.isEmpty(b)||(this.timeline.push([this.index,h(this.lastDiff,this.keyMap)]),this.lastDiff=b,this.lastState=a,this.index=0)}else this.lastDiff=this.lastState=a;++this.index};a.StateRecorder.prototype.serialize=function(){var a={},e;for(e in this.keyMap)a[this.keyMap[e]]=e;this.timeline.push([this.index,h(this.lastDiff,this.keyMap)]);this.lastDiff={};this.index=0;return{freq:this.freq,keyMap:a,
timeline:this.timeline}};a.StatePlayback=function(a,e){this.object=a;this.serialized=e;this.index=0;this.freq=e.freq;this.nextSeg=this.freqCount=0;this.pubsub=new m.PubSub};a.StatePlayback.prototype.step=function(){if(this.freq){if(++this.freqCount!=this.freq)return;this.freqCount=0}var a=this.serialized.timeline[this.nextSeg];a&&(b(this.object,a[1],this.serialized.keyMap),++this.index>=a[0]&&(this.index=0,++this.nextSeg>=this.serialized.timeline.length&&this.pubsub.publish("complete")))};var e=function(a,
b){if(c.isArray(b)){var f=b[0],i=[];a.forEach(function(a){i.push(e(a,f))});return i}return"object"===typeof b?(i={},c.each(b,function(f,b){i[b]=e(a[b],f)}),i):a.toFixed(b)}})("undefined"===typeof exports?this[MODULE]={}:exports);MODULE="pterrain";
(function(a){var g=(this.THREE||require("../THREE")).Vector3,b=!1;if("undefined"===typeof Image)var b=!0,d=require("canvas");a.ImageSource=function(){this.hmap=null;this.onload=[]};a.ImageSource.prototype.load=function(a,c){if(b)require("fs").readFile(__dirname+"/../public"+a,function(a,b){if(a)throw Error(a);var h=new d.Image;h.src=b;this.loadWithImage(h,c)}.bind(this));else{var g=new Image;g.onload=this.loadWithImage.bind(this,g,c);g.src=a}};a.ImageSource.prototype.loadWithImage=function(a,c){var g=
this.cx=a.width,e=this.cy=a.height,k;b?k=new d(g,e):(k=document.createElement("canvas"),k.width=g,k.height=e);k=k.getContext("2d");k.drawImage(a,0,0);this.hmap=k.getImageData(0,0,g,e).data;for(var l in this.onload)this.onload[l]();c&&c(this)};a.ImageSource.prototype.loadTile=function(a,b,d,e,k,g){if(this.hmap){var f=this.cx,i=this.cy,n=this.hmap,p=new Float32Array(d*e),j,s,o=0;for(s=b;s<b+e;++s){j=s%i;0>j&&(j+=i);var q=j*f;for(j=a;j<a+d;++j){var r=j%f;0>r&&(r+=f);p[++o]=n[4*(r+q)]*k}}g(p)}else this.onload.push(this.loadTile.bind(this,
a,b,d,e,k,g))};a.Terrain=function(a){this.tileSize=128;this.scaleVt=this.scaleHz=1;this.tileTotalSize=this.tileSize*this.scaleHz;this.tiles={};this.source=a};a.Terrain.prototype.getTile=function(a,b){return this.tiles[a+","+b]};a.Terrain.prototype.loadTile=function(b,c,d){var e=b+","+c;if(e in this.tiles)d(this.tiles[e]);else{var k=this.tileSize,g=k+1;this.source.loadTile(b*k,c*k,g,g,this.scaleVt,function(f){f=new a.TerrainTile(this,b,c,f);this.tiles[e]=f;d&&d(f)}.bind(this))}};a.Terrain.prototype.getContact=
function(a){return this.getContactRayZ(a.x,-a.z)};a.Terrain.prototype.getContactRayZ=function(a,b){var d=null,e=a/this.scaleHz,k=b/this.scaleHz,g=Math.floor(e/this.tileSize),f=Math.floor(k/this.tileSize),i=this.getTile(g,f);if(i&&(d=i.getContactRayZ(e-g*this.tileSize,k-f*this.tileSize)))d.surfacePos.x=a,d.surfacePos.z=-b;return d};a.TerrainTile=function(a,b,d,e){this.terrain=a;this.size=a.tileSize;this.heightMap=e};a.TerrainTile.prototype.getContactRayZ=function(a,b){var d=Math.floor(a),e=Math.floor(b),
k=a-d,l=b-e,f=this.size+1,i=this.heightMap[d+0+(e+0)*f],n=this.heightMap[d+1+(e+0)*f],p=this.heightMap[d+0+(e+1)*f],e=this.heightMap[d+1+(e+1)*f],d=new g;d.z=this.terrain.scaleHz;1>k+l?(d.x=i-n,d.y=i-p,k=i+(n-i)*k+(p-i)*l):(d.x=p-e,d.y=n-e,k=e+(p-e)*(1-k)+(n-e)*(1-l));return{normal:(new g(d.x,d.z,-d.y)).normalize(),surfacePos:new g(0,k,0)}}})("undefined"===typeof exports?this[MODULE]={}:exports);MODULE="psim";
(function(a){var g=this.THREE||require("../THREE"),b=this.pubsub||require("./pubsub"),d=this.util||require("./util"),h=g.Vector3,c=g.Quaternion,m=d.QuatFromEuler;a.Sim=function(a){this.gravity=new h(0,-9.81,0);this.objects=[];this.staticObjects=[];this.cylinders=[];this.cylLists={};this.timeAccumulator=this.time=0;this.timeStep=a;this.alpha=0;this.pubsub=new b.PubSub};a.Sim.prototype.addObject=function(a){this.objects.push(a)};a.Sim.prototype.addStaticObject=function(a){this.staticObjects.push(a)};a.Sim.prototype.tick=
function(a){if(!(0>=a)){0.1<a&&(a=0.1);var b=this.timeStep;for(this.timeAccumulator+=a;this.timeAccumulator>=b;)this.timeAccumulator-=b,this.step();this.alpha=this.timeAccumulator/b;this.objects.forEach(function(a){"function"===typeof a.getState&&(a.interp=a.getState())})}};a.Sim.prototype.step=function(){this.pubsub.publish("step");this.integrate(this.timeStep);this.time+=this.timeStep};a.Sim.prototype.interpolatedTime=function(){return this.time+this.timeAccumulator};a.Sim.prototype.integrate=function(a){this.objects.forEach(function(a){"function"===
typeof a.recordState&&a.recordState()});this.objects.forEach(function(b){b.tick(a)})};a.Sim.prototype.collide=function(a){var b,d=[],f=new h,i=new h;for(b=0;b<this.staticObjects.length;++b){var c=this.staticObjects[b].getContact(a);if(c){var g=f.copy(c.surfacePos).subSelf(a);c.depth=g.dot(c.normal);0<c.depth&&d.push(c)}}var j=new h(0,1,0);(b=this.getCylList(a))&&b.forEach(function(b){i.copy(a).subSelf(b);var o=i.subSelf(f.copy(j).multiplyScalar(i.dot(j))),q=o.length();q<b.radius&&(b=b.radius-q,o=
{normal:o.clone(),surfacePos:a.addSelf(f.copy(o).multiplyScalar(b)),depth:b},d.push(o))});return d};a.Sim.prototype.getCylList=function(a){return this.cylLists[Math.round(0.1*a.x)+","+Math.round(0.1*a.z)]};a.Sim.prototype.addCylinder=function(a){this.cylinders.push(a);var b=Math.round(0.1*a.x),d=Math.round(0.1*a.z),f=Math.ceil(0.1*a.radius),i,c;for(c=-f;c<=f;++c)for(i=-f;i<=f;++i){var g=i+b+","+(c+d);(this.cylLists[g]||(this.cylLists[g]=[])).push(a)}};a.Sim.prototype.collideConvexHull=function(a,
b){new h(0,1,0);this.cylinders.forEach(function(a){(new h.sub(a,b)).lengthSq()})};a.Sim.prototype.collideLineSegment=function(a,b){var d,f=[],i=b.clone().subSelf(a),c=i.length();i.divideScalar(c);var g=new h(0,1,0),j=(new h).cross(g,i),s=j.dot(a);for(d=0;d<this.cylinders.length;++d){var o=this.cylinders[d],q=j.dot(o);if(Math.abs(s-q)<o.radius&&(q=i.dot(o)-i.dot(a),0<q&&q<c)){var q=i.clone().multiplyScalar(q).addSelf(a),r=q.clone().subSelf(o),r=r.subSelf(g.clone().multiplyScalar(r.dot(g)));r.normalize();
var v=q.clone().subSelf(o).dot(r),o=o.radius-v,o={normal:r,surfacePos:q.addSelf(r.clone().multiplyScalar(o)),depth:o};f.push(o)}}return f};a.ReferenceFrame=function(){this.pos=new h;this.ori=new c;this.oriMat=new g.Matrix4;this.oriMatInv=new g.Matrix4};a.ReferenceFrame.prototype.updateMatrices=function(){this.ori.normalize();this.oriMat.setRotationFromQuaternion(this.ori);this.oriMatInv.copy(this.oriMat).transpose()};a.ReferenceFrame.prototype.getLocToWorldVector=function(a){a=a.clone();this.oriMat.multiplyVector3(a);
return a};a.ReferenceFrame.prototype.getWorldToLocVector=function(a){a=a.clone();this.oriMatInv.multiplyVector3(a);return a};a.ReferenceFrame.prototype.getLocToWorldPoint=function(a){a=a.clone();this.oriMat.multiplyVector3(a);a.addSelf(this.pos);return a};a.ReferenceFrame.prototype.getWorldToLocPoint=function(a){a=a.clone().subSelf(this.pos);this.oriMatInv.multiplyVector3(a);return a};a.RigidBody=function(b){a.ReferenceFrame.call(this);this.sim=b;b.addObject(this);this.angMass=new h;this.angMassInv=
new h;this.setMassCuboid(1,new h(1,1,1));this.linVel=new h;this.angVel=new h;this.accumForce=new h;this.accumTorque=new h;this.recordState()};a.RigidBody.prototype=Object.create(new a.ReferenceFrame);a.RigidBody.prototype.recordState=function(){this.old={pos:this.pos.clone(),ori:(new c).copy(this.ori),linVel:this.linVel.clone(),angVel:this.angVel.clone()}};a.RigidBody.prototype.getState=function(){var a=this.old,b=this.sim.alpha;return{pos:new h(a.pos.x+(this.pos.x-a.pos.x)*b,a.pos.y+(this.pos.y-
a.pos.y)*b,a.pos.z+(this.pos.z-a.pos.z)*b),ori:new c(a.ori.x+(this.ori.x-a.ori.x)*b,a.ori.y+(this.ori.y-a.ori.y)*b,a.ori.z+(this.ori.z-a.ori.z)*b,a.ori.w+(this.ori.w-a.ori.w)*b),linVel:new h(a.linVel.x+(this.linVel.x-a.linVel.x)*b,a.linVel.y+(this.linVel.y-a.linVel.y)*b,a.linVel.z+(this.linVel.z-a.linVel.z)*b),angVel:new h(a.angVel.x+(this.angVel.x-a.angVel.x)*b,a.angVel.y+(this.angVel.y-a.angVel.y)*b,a.angVel.z+(this.angVel.z-a.angVel.z)*b)}};a.RigidBody.prototype.setMassCuboid=function(a,b){0>=
a||0>=b.x||0>=b.y||0>=b.z||(this.mass=a,this.angMass.x=b.y*b.z,this.angMass.y=b.z*b.x,this.angMass.z=b.x*b.y,this.angMass.multiplyScalar(a),this.angMassInv.x=1/this.angMass.x,this.angMassInv.y=1/this.angMass.y,this.angMassInv.z=1/this.angMass.z)};a.RigidBody.prototype.getLinearVel=function(){return this.linVel};a.RigidBody.prototype.addForce=function(a){this.accumForce.addSelf(a)};a.RigidBody.prototype.addLocForce=function(a){this.addForce(this.getLocToWorldVector(a))};a.RigidBody.prototype.addForceAtPoint=
function(a,b){this.accumForce.addSelf(a);var d=this.getWorldToLocPoint(b),f=this.getWorldToLocVector(a);this.addTorque((new h).cross(d,f))};a.RigidBody.prototype.addLocForceAtPoint=function(a,b){this.addForceAtPoint(this.getLocToWorldVector(a),b)};a.RigidBody.prototype.addForceAtLocPoint=function(a,b){this.addForceAtPoint(a,this.getLocToWorldPoint(b))};a.RigidBody.prototype.addLocForceAtLocPoint=function(a,b){this.addForceAtPoint(this.getLocToWorldVector(a),this.getLocToWorldPoint(b))};a.RigidBody.prototype.addTorque=
function(a){this.accumTorque.addSelf(a)};a.RigidBody.prototype.addLocTorque=function(a){this.addTorque(this.getLocToWorldVector(a))};a.RigidBody.prototype.getLinearVelAtPoint=function(a){var a=a.clone().subSelf(this.pos),b=this.getLocToWorldVector(this.angVel),a=(new h).cross(b,a);return(new h).add(this.linVel,a)};a.RigidBody.prototype.tick=function(a){var b=this.accumForce.clone().divideScalar(this.mass);b.addSelf(this.sim.gravity);this.linVel.addSelf(b.multiplyScalar(a));this.pos.addSelf(this.linVel.clone().multiplyScalar(a));
this.angVel.addSelf((new h).multiply(this.accumTorque,this.angMassInv).clone().multiplyScalar(a));a=this.angVel.clone().multiplyScalar(a);this.ori.multiplySelf(m(a));this.accumForce.x=this.accumForce.y=this.accumForce.z=0;this.accumTorque.x=this.accumTorque.y=this.accumTorque.z=0;this.updateMatrices()}})("undefined"===typeof exports?this[MODULE]={}:exports);MODULE="pvehicle";
(function(a){function g(a,b){if(0>=a)return 0;if(a<=b[0].radps)return b[0].power*a/b[0].radps;var f;for(f=1;f<b.length;++f)if(a<=b[f].radps)return j(b[f-1].power,b[f].power,(a-b[f-1].radps)/(b[f].radps-b[f-1].radps));return b[f-1].power}this._||require("underscore");var b=this.LFIB4||require("./LFIB4"),d=this.THREE||require("../THREE"),h=this.psim||require("./psim"),c=this.util||require("./util"),m=d.Vector2,e=d.Vector3,k=d.Quaternion,l=c.Vec3FromArray,f=c.TWOPI,i=c.PULLTOWARD,n=c.MOVETOWARD,p=c.CLAMP,
j=c.INTERP;a.AutomaticController=function(a){this.vehicle=a;this.shiftTimer=0;this.input={forward:0,back:0,left:0,right:0,handbrake:0};this.output={throttle:0,clutch:1,gear:1,brake:0,handbrake:0,desiredTurnPos:0}};a.AutomaticController.prototype.tick=function(a){var b=this.input,f=this.output,d=this.vehicle,c=d.cfg.engine.powerband,e=function(a){var b=d.engineAngVel*d.gearRatios[a]/d.gearRatios[f.gear];return g(b,c)*d.gearRatios[a]/b},p=b.forward,n=b.back,h=g(d.engineAngVel,c)*d.gearRatios[f.gear]/
d.engineAngVel;0>=this.shiftTimer?f.clutch&&1<=f.gear?1<f.gear&&e(f.gear-1)>h?(f.gear-=1,this.shiftTimer=0.2):f.gear<d.gearRatios.length-1&&e(f.gear+1)>h?(f.gear+=1,this.shiftTimer=0.2):n&&1>d.differentialAngVel&&(f.gear=-1,this.shiftTimer=0.2):-1==f.gear&&(p?(f.gear=1,this.shiftTimer=0.2):(p=n,n=0)):this.shiftTimer-=a;f.throttle=i(f.throttle,p,8*a);f.brake=i(f.brake,n,5*a);f.handbrake=i(f.handbrake,b.handbrake,20*a);f.desiredTurnPos=i(f.desiredTurnPos,b.left-b.right,5*a);f.clutch=1;f.clutch*=0.5>
f.handbrake?1:0};a.Vehicle=function(d,c){this.sim=d;d.addObject(this);this.cfg=c;this.body=new h.RigidBody(d);this.body.setMassCuboid(c.mass,l(c.dimensions).multiplyScalar(0.5));this.wheelTurnPos=-1;for(var i=this.totalDrive=this.wheelTurnVel=0;i<c.clips.length;++i){var e=c.clips[i];e.pos[0]-=c.center[0];e.pos[1]-=c.center[1];e.pos[2]-=c.center[2]}this.wheels=[];for(i=0;i<c.wheels.length;++i)e=this.wheels[i]={},e.cfg=c.wheels[i],e.cfg.pos[0]-=c.center[0],e.cfg.pos[1]-=c.center[1],e.cfg.pos[2]-=c.center[2],
e.ridePos=0,e.rideVel=0,e.spinPos=0,e.spinVel=0,e.bumpLast=0,e.bumpNext=0,e.bumpTravel=0,e.frictionForce=new m,this.totalDrive+=e.cfg.drive||0;this.controller=new a.AutomaticController(this);for(i=0;i<c.engine.powerband.length;++i)c.engine.powerband[i].radps=c.engine.powerband[i].rpm*f/60;this.engineAngVelSmoothed=this.engineAngVel=0;this.engineIdle=c.engine.powerband[0].radps;this.engineRedline=c.engine.redline*f/60;this.engineRecover=0.98*this.engineRedline;this.engineOverspeed=!1;this.enginePowerscale=
1E3*c.engine.powerscale;i=c.transmission["final"];this.gearRatios=[];this.gearRatios[-1]=-c.transmission.reverse*i;for(e=this.gearRatios[0]=0;e<c.transmission.forward.length;++e)this.gearRatios[e+1]=c.transmission.forward[e]*i;this.skidLevel=this.crashLevelPrev=this.crashLevel=this.recoverTimer=0;this.disabled=!1;this.random=b.LFIB4(5)};a.Vehicle.prototype.recordState=function(){};a.Vehicle.prototype.getState=function(){return{}};a.Vehicle.prototype.recover=function(a){var b=this.recoverState,f=this.body;
b||(b=Math.atan2(f.oriMat.n13,f.oriMat.n11),b=(new k).setFromAxisAngle(new e(0,1,0),Math.PI-b),0>b.x*f.ori.x+b.y*f.ori.y+b.z*f.ori.z+b.w*f.ori.w&&(b.x*=-1,b.y*=-1,b.z*=-1,b.w*=-1),b=this.recoverState={pos:f.pos.clone().addSelf(l(this.cfg.recover.posOffset)),ori:b},this.disabled=!0);a*=4;f.pos.x=i(f.pos.x,b.pos.x,a);f.pos.y=i(f.pos.y,b.pos.y,a);f.pos.z=i(f.pos.z,b.pos.z,a);f.ori.x=i(f.ori.x,b.ori.x,a);f.ori.y=i(f.ori.y,b.ori.y,a);f.ori.z=i(f.ori.z,b.ori.z,a);f.ori.w=i(f.ori.w,b.ori.w,a);f.linVel.set(0,
0,0);f.angVel.set(0,0,0);this.recoverTimer>=this.cfg.recover.releaseTime&&(this.recoverTimer=0,this.recoverState=null,this.disabled=!1)};a.Vehicle.prototype.tick=function(a){var b;this.controller.tick(a);var f=this.cfg.engine.powerband,c=this.controller.output,d=c.throttle;this.disabled&&(c.clutch=0,c.brake=1,c.desiredTurnPos=0);this.crashLevelPrev=i(this.crashLevelPrev,this.crashLevel,5*a);this.crashLevel=i(this.crashLevel,0,5*a);this.skidLevel=0;0.1>=this.body.oriMat.n22||this.recoverTimer>=this.cfg.recover.triggerTime?
(this.recoverTimer+=a,this.recoverTimer>=this.cfg.recover.triggerTime&&this.recover(a)):this.recoverTimer=0;var e=0,h=0;for(b=0;b<this.wheels.length;++b)var j=this.wheels[b],e=e+j.spinVel*(j.cfg.drive||0),h=h+j.frictionForce.x;this.differentialAngVel=e/=this.totalDrive;b=this.gearRatios[c.gear];0!=b&&c.clutch&&(this.engineAngVel=e*b);this.engineAngVel<this.engineIdle&&(this.engineAngVel=this.engineIdle);if(this.engineOverspeed){if(this.engineOverspeed=this.engineAngVel>this.engineRecover)d=0,c.throttle=
0}else this.engineAngVel>this.engineRedline&&(d=0,this.engineOverspeed=!0);j=d-0.5;j=0<=j?j/0.5:j/0.5;j=0<=j?j*this.enginePowerscale*g(this.engineAngVel,f)/this.engineAngVel:0.1*j*(this.engineAngVel-this.engineIdle);f=0;0!=b&&c.clutch?f=j*b/this.totalDrive:(this.engineAngVel+=5E4*j*a/this.cfg.engine.flywheel,this.engineAngVel<this.engineIdle&&(this.engineAngVel=this.engineIdle));for(b=0;b<this.wheels.length;++b)j=this.wheels[b],d=0.3*j.frictionForce.y,j.cfg.drive&&(d+=(f-400*(j.spinVel-e))*j.cfg.drive),
j.spinVel+=0.13*d*a,d=c.brake*(j.cfg.brake||0)+c.handbrake*(j.cfg.handbrake||0),0<d&&(j.spinVel=n(j.spinVel,0,d*a));for(b=0;b<this.cfg.clips.length;++b)this.clipPoint(this.cfg.clips[b]);for(b=0;b<this.cfg.clipEdges.length;++b)this.clipEdge(this.cfg.clipEdges[b]);c=300*(c.desiredTurnPos-this.wheelTurnPos)+-0.0050*h;c=p(c,-8,8);this.wheelTurnVel=i(this.wheelTurnVel,c,10*a);this.wheelTurnPos+=this.wheelTurnVel*a;this.wheelTurnPos=p(this.wheelTurnPos,-1,1);for(b=0;b<this.cfg.wheels.length;++b)this.tickWheel(this.wheels[b],
a);this.engineAngVelSmoothed=i(this.engineAngVelSmoothed,this.engineAngVel,20*a)};var s=function(a,b){var f={};f.w=a;f.v=(new e).cross(a,b);f.v.normalize();f.u=(new e).cross(f.v,a);f.u.normalize();return f};a.Vehicle.prototype.clipPoint=function(a){a=this.body.getLocToWorldPoint(l(a.pos));this.body.getLinearVelAtPoint(a);for(var a=this.sim.collide(a),b=0;b<a.length;++b)this.contactResponse(a[b])};a.Vehicle.prototype.clipHull=function(){var a=[new Vec4(1,0,0,this.cfg.dimensions[0]),new Vec4(-1,0,0,
-this.cfg.dimensions[0]),new Vec4(0,1,0,this.cfg.dimensions[1]),new Vec4(0,-1,0,-this.cfg.dimensions[1]),new Vec4(0,0,1,this.cfg.dimensions[2]),new Vec4(0,0,-1,-this.cfg.dimensions[2])];a.forEach(function(a){this.body.oriMat.multiplyVector4(a)});for(var a=this.sim.collideConvexHull(a,this.body.pos,5),b=0;b<a.length;++b)this.contactResponse(a[b])};a.Vehicle.prototype.clipEdge=function(a){for(var b=this.cfg.clips[a[1]],a=this.body.getLocToWorldPoint(l(this.cfg.clips[a[0]].pos)),b=this.body.getLocToWorldPoint(l(b.pos)),
b=this.sim.collideLineSegment(a,b),a=0;a<b.length;++a)this.contactResponse(b[a])};a.Vehicle.prototype.contactResponse=function(a){var b=s(a.normal,new e(1,0,0)),f=this.body.getLinearVelAtPoint(a.surfacePos),c=new e(f.dot(b.u),f.dot(b.v),f.dot(b.w)),f=2E5*a.depth-8E3*c.z;if(0<f){var c=(new m(-c.x,-c.y)).multiplyScalar(1E4),d=0.81*f,i=1.08*f,g=c.length();g>i&&c.multiplyScalar(d/g);d=b.w.multiplyScalar(f);d.addSelf(b.u.multiplyScalar(c.x));d.addSelf(b.v.multiplyScalar(c.y));this.body.addForceAtPoint(d,
a.surfacePos);this.crashLevel=Math.max(this.crashLevel,f)}};a.Vehicle.prototype.tickWheel=function(a,b){var c=7E4*a.ridePos;a.frictionForce.set(0,0);a.rideVel-=c/15*b;a.rideVel*=1/(1+50*b);a.ridePos+=a.rideVel*b;a.spinPos+=a.spinVel*b;a.spinPos-=Math.floor(a.spinPos/f)*f;var d=this.body.getLocToWorldPoint(l(a.cfg.pos));d.y+=a.ridePos-a.cfg.radius;for(var i=this.body.getLinearVelAtPoint(d),g=this.sim.collide(d),p=0;p<g.length;++p){var j=g[p],n=s(j.normal,this.getWheelRightVector(a)),h=new e(i.dot(n.u),
i.dot(n.v),i.dot(n.w));h.y+=a.spinVel*a.cfg.radius;this.skidLevel+=Math.sqrt(h.x*h.x+h.y*h.y);var k=c-8E3*h.z;a.ridePos+=j.depth;0.13<a.ridePos&&(a.ridePos=0.13,a.rideVel=0,k=2E5*j.depth-8E3*h.z);a.rideVel<-h.z&&(a.rideVel=-h.z);if(0<k){var j=(new m(-h.x,-h.y)).multiplyScalar(3E3),h=1.08*k,w=1.44*k,u=j.length();u>w&&j.multiplyScalar(h/u);a.frictionForce.addSelf(j);k=n.w.multiplyScalar(k);k.addSelf(n.u.multiplyScalar(j.x));k.addSelf(n.v.multiplyScalar(j.y));this.body.addForceAtPoint(k,d)}}};a.Vehicle.prototype.getWheelTurnPos=
function(a){return(a.cfg.turn||0)*this.wheelTurnPos};a.Vehicle.prototype.getWheelRightVector=function(a){var b=this.getWheelTurnPos(a),a=Math.cos(b),b=Math.sin(b),f=this.body.oriMat.getColumnX().clone(),c=this.body.oriMat.getColumnZ();return new e(f.x*a-c.x*b,f.y*a-c.y*b,f.z*a-c.z*b)};a.Vehicle.prototype.getCrashNoiseLevel=function(){return this.crashLevel>this.crashLevelPrev?(this.crashLevelPrev=2*this.crashLevel,this.crashLevel):0};a.Vehicle.prototype.grabSnapshot=function(){return filterObject(this,
keys)}})("undefined"===typeof exports?this[MODULE]={}:exports);MODULE="track";
(function(a){var g=this.LFIB4||require("./LFIB4"),b=this.THREE||require("../THREE"),d=this.pterrain||require("./pterrain"),h=b.Vector3;a.Track=function(){this.config={};this.checkpoints=[];this.trees=[]};a.Track.prototype.loadWithConfig=function(a,b){this.config=a;this.setup();if(a.terrain){var e=new d.ImageSource(a.terrain.heightmap);e.load(a.terrain.heightmap);e=new d.Terrain(e);e.scaleHz=a.terrain.horizontalscale;e.scaleVt=a.terrain.verticalscale;this.terrain=e;e.loadTile(0,0,function(){var d,e=
g.LFIB4(a.randomseed);for(d=0;70>d;++d){var f=new h(50+150*e(),0,-50-284*e()),i=this.terrain.getContact(f);f.y=i.surfacePos.y;f.rot=2*e()*Math.PI;f.scl=3*e()+3;f.radius=1.2;this.trees.push(f)}e=a.course;f=e.checkpoints;for(d=0;d<f.length;++d){var n=new h(f[d].pos[0]*e.coordscale[0],0,f[d].pos[1]*e.coordscale[1]),i=this.terrain.getContact(n);n.y=i.surfacePos.y+2;this.checkpoints.push(n)}b&&b()}.bind(this))}};a.Track.prototype.setup=function(){}})("undefined"===typeof exports?this[MODULE]={}:exports);MODULE="game";
(function(a){var g=this.THREE||require("../THREE"),b=this.track||require("./track"),d=this.psim||require("./psim"),h=this.pvehicle||require("./pvehicle"),c=this.pubsub||require("./pubsub"),m=g.Vector2;a.Progress=function(a,b){this.checkpoints=a.checkpoints;this.vehicle=b;this.nextCpIndex=0;this.pubsub=new c.PubSub;this.lastCpDistSq=0;this.cpTimes=[]};a.Progress.prototype.nextCheckpoint=function(a){return this.checkpoints[this.nextCpIndex+(a||0)]||null};a.Progress.prototype.update=function(){var a=this.vehicle,
b=this.nextCheckpoint(0);if(b){b=(new m(a.body.pos.x-b.x,a.body.pos.z-b.z)).lengthSq();if(64>b){var d=Math.sqrt(b),f=Math.sqrt(this.lastCpDistSq),d=(f-Math.sqrt(64))/(f-d);this.advanceCheckpoint(a.sim.time-a.sim.timeStep*d)}this.lastCpDistSq=b}};a.Progress.prototype.finishTime=function(){return this.cpTimes[this.checkpoints.length-1]||null};a.Progress.prototype.advanceCheckpoint=function(a){++this.nextCpIndex;this.cpTimes.push(a);this.pubsub.publish("advance")};a.Game=function(a){this.http=a;this.track=
new b.Track;this.progs=[];this.sim=new d.Sim(1/150);this.startTime=3;this.sim.pubsub.subscribe("step",this.onSimStep.bind(this))};a.Game.prototype.interpolatedRaceTime=function(){return this.sim.interpolatedTime()-this.startTime};a.Game.prototype.setTrack=function(a,b){this.http.get({path:a},function(a,f){if(a)if(b)b(a);else throw Error("Failed to fetch track: "+a);else this.setTrackConfig(JSON.parse(f),b)}.bind(this))};a.Game.prototype.setTrackConfig=function(a,b){this.track.loadWithConfig(a,function(){this.sim.addStaticObject(this.track.terrain);
this.track.trees.forEach(function(a){this.sim.addCylinder(a)}.bind(this));b&&b(null,this.track)}.bind(this))};a.Game.prototype.addCar=function(a,b){this.http.get({path:a},function(a,f){if(a)if(b)b(a);else throw Error("Failed to fetch car: "+a);else this.addCarConfig(JSON.parse(f),b)}.bind(this))};a.Game.prototype.addCarConfig=function(b,d){var c=new h.Vehicle(this.sim,b);c.body.pos.x=100;c.body.pos.y=10;c.body.pos.z=-100;c.body.ori=new g.Quaternion(0,0.5,0,0.5);c.body.ori.normalize();c=new a.Progress(this.track,
c);this.progs.push(c);d&&d(null,c)};a.Game.prototype.onSimStep=function(){var a=this.sim.time<this.startTime;this.progs.forEach(function(b){b.update();b.vehicle.disabled=a})}})("undefined"===typeof exports?this[MODULE]={}:exports);var require=function(a){return window[a]},getUrlVars=function(a){for(var g={},a=a.substring(1).split("&"),b=0;b<a.length;++b){var d=a[b].split("=");2==d.length&&(g[d[0]]=decodeURIComponent(d[1]))}return g};function $(a){return document.getElementById(a)}function $$(a){return document.getElementsByClassName(a)};(function(){var a={},g=this,b=g.async;"undefined"!==typeof module&&module.exports?module.exports=a:g.async=a;a.noConflict=function(){g.async=b;return a};var d=function(a,b){if(a.forEach)return a.forEach(b);for(var c=0;c<a.length;c+=1)b(a[c],c,a)},h=function(a,b){if(a.map)return a.map(b);var c=[];d(a,function(a,f,d){c.push(b(a,f,d))});return c},c=function(a,b,c){if(a.reduce)return a.reduce(b,c);d(a,function(a,f,d){c=b(c,a,f,d)});return c},m=function(a){if(Object.keys)return Object.keys(a);var b=[],
c;for(c in a)a.hasOwnProperty(c)&&b.push(c);return b};a.nextTick="undefined"===typeof process||!process.nextTick?function(a){setTimeout(a,0)}:process.nextTick;a.forEach=function(a,b,c){if(!a.length)return c();var e=0;d(a,function(d){b(d,function(b){b?(c(b),c=function(){}):(e+=1,e===a.length&&c())})})};a.forEachSeries=function(a,b,c){if(!a.length)return c();var d=0,e=function(){b(a[d],function(b){b?(c(b),c=function(){}):(d+=1,d===a.length?c():e())})};e()};a.forEachLimit=function(a,b,c,d){if(!a.length||
0>=b)return d();var e=0,g=0,h=0;(function r(){if(e===a.length)return d();for(;h<b&&g<a.length;)c(a[g],function(b){b?(d(b),d=function(){}):(e+=1,h-=1,e===a.length?d():r())}),g+=1,h+=1})()};var e=function(b){return function(){var c=Array.prototype.slice.call(arguments);return b.apply(null,[a.forEach].concat(c))}},k=function(b){return function(){var c=Array.prototype.slice.call(arguments);return b.apply(null,[a.forEachSeries].concat(c))}},l=function(a,b,c,d){var e=[],b=h(b,function(a,b){return{index:b,
value:a}});a(b,function(a,b){c(a.value,function(c,d){e[a.index]=d;b(c)})},function(a){d(a,e)})};a.map=e(l);a.mapSeries=k(l);a.reduce=function(b,c,d,e){a.forEachSeries(b,function(a,b){d(c,a,function(a,d){c=d;b(a)})},function(a){e(a,c)})};a.inject=a.reduce;a.foldl=a.reduce;a.reduceRight=function(b,c,d,e){b=h(b,function(a){return a}).reverse();a.reduce(b,c,d,e)};a.foldr=a.reduceRight;l=function(a,b,c,d){var e=[],b=h(b,function(a,b){return{index:b,value:a}});a(b,function(a,b){c(a.value,function(c){c&&
e.push(a);b()})},function(){d(h(e.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};a.filter=e(l);a.filterSeries=k(l);a.select=a.filter;a.selectSeries=a.filterSeries;l=function(a,b,c,d){var e=[],b=h(b,function(a,b){return{index:b,value:a}});a(b,function(a,b){c(a.value,function(c){c||e.push(a);b()})},function(){d(h(e.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};a.reject=e(l);a.rejectSeries=k(l);l=function(a,b,c,d){a(b,function(a,b){c(a,function(c){c?
(d(a),d=function(){}):b()})},function(){d()})};a.detect=e(l);a.detectSeries=k(l);a.some=function(b,c,d){a.forEach(b,function(a,b){c(a,function(a){a&&(d(!0),d=function(){});b()})},function(){d(!1)})};a.any=a.some;a.every=function(b,c,d){a.forEach(b,function(a,b){c(a,function(a){a||(d(!1),d=function(){});b()})},function(){d(!0)})};a.all=a.every;a.sortBy=function(b,c,d){a.map(b,function(a,b){c(a,function(c,d){c?b(c):b(null,{value:a,criteria:d})})},function(a,b){if(a)return d(a);d(null,h(b.sort(function(a,
b){var c=a.criteria,d=b.criteria;return c<d?-1:c>d?1:0}),function(a){return a.value}))})};a.auto=function(a,b){var b=b||function(){},e=m(a);if(!e.length)return b(null);var g={},h=[],k=function(a){h.unshift(a)},o=function(){d(h.slice(0),function(a){a()})};k(function(){m(g).length===e.length&&(b(null,g),b=function(){})});d(e,function(d){var e=a[d]instanceof Function?[a[d]]:a[d],n=function(a){if(a)b(a),b=function(){};else{var c=Array.prototype.slice.call(arguments,1);1>=c.length&&(c=c[0]);g[d]=c;o()}},
m=e.slice(0,Math.abs(e.length-1))||[],l=function(){return c(m,function(a,b){return a&&g.hasOwnProperty(b)},!0)};if(l())e[e.length-1](n,g);else{var t=function(){if(l()){for(var a=t,b=0;b<h.length;b+=1)if(h[b]===a){h.splice(b,1);break}e[e.length-1](n,g)}};k(t)}})};a.waterfall=function(b,c){if(!b.length)return c();var c=c||function(){},d=function(b){return function(f){if(f)c(f),c=function(){};else{var e=Array.prototype.slice.call(arguments,1),g=b.next();g?e.push(d(g)):e.push(c);a.nextTick(function(){b.apply(null,
e)})}}};d(a.iterator(b))()};a.parallel=function(b,c){c=c||function(){};if(b.constructor===Array)a.map(b,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);1>=c.length&&(c=c[0]);b.call(null,a,c)})},c);else{var d={};a.forEach(m(b),function(a,c){b[a](function(b){var f=Array.prototype.slice.call(arguments,1);1>=f.length&&(f=f[0]);d[a]=f;c(b)})},function(a){c(a,d)})}};a.series=function(b,c){c=c||function(){};if(b.constructor===Array)a.mapSeries(b,function(a,b){a&&a(function(a){var c=
Array.prototype.slice.call(arguments,1);1>=c.length&&(c=c[0]);b.call(null,a,c)})},c);else{var d={};a.forEachSeries(m(b),function(a,c){b[a](function(b){var f=Array.prototype.slice.call(arguments,1);1>=f.length&&(f=f[0]);d[a]=f;c(b)})},function(a){c(a,d)})}};a.iterator=function(a){var b=function(c){var d=function(){a.length&&a[c].apply(null,arguments);return d.next()};d.next=function(){return c<a.length-1?b(c+1):null};return d};return b(0)};a.apply=function(a){var b=Array.prototype.slice.call(arguments,
1);return function(){return a.apply(null,b.concat(Array.prototype.slice.call(arguments)))}};l=function(a,b,c,d){var e=[];a(b,function(a,b){c(a,function(a,c){e=e.concat(c||[]);b(a)})},function(a){d(a,e)})};a.concat=e(l);a.concatSeries=k(l);a.whilst=function(b,c,d){b()?c(function(e){if(e)return d(e);a.whilst(b,c,d)}):d()};a.until=function(b,c,d){b()?d():c(function(e){if(e)return d(e);a.until(b,c,d)})};a.queue=function(b,c){var e=0,g={tasks:[],concurrency:c,saturated:null,empty:null,drain:null,push:function(b,
e){b.constructor!==Array&&(b=[b]);d(b,function(b){g.tasks.push({data:b,callback:"function"===typeof e?e:null});g.saturated&&g.tasks.length==c&&g.saturated();a.nextTick(g.process)})},process:function(){if(e<g.concurrency&&g.tasks.length){var a=g.tasks.shift();g.empty&&0==g.tasks.length&&g.empty();e+=1;b(a.data,function(){e-=1;a.callback&&a.callback.apply(a,arguments);g.drain&&0==g.tasks.length+e&&g.drain();g.process()})}},length:function(){return g.tasks.length},running:function(){return e}};return g};
e=function(a){return function(b){var c=Array.prototype.slice.call(arguments,1);b.apply(null,c.concat([function(b){var c=Array.prototype.slice.call(arguments,1);"undefined"!==typeof console&&(b?console.error&&console.error(b):console[a]&&d(c,function(b){console[a](b)}))}]))}};a.log=e("log");a.dir=e("dir");a.memoize=function(a,b){var c={},d={},b=b||function(a){return a},e=function(){var e=Array.prototype.slice.call(arguments),g=e.pop(),h=b.apply(null,e);h in c?g.apply(null,c[h]):h in d?d[h].push(g):
(d[h]=[g],a.apply(null,e.concat([function(){c[h]=arguments;var a=d[h];delete d[h];for(var b=0,e=a.length;b<e;b++)a[b].apply(null,arguments)}])))};e.unmemoized=a;return e};a.unmemoize=function(a){return function(){return(a.unmemoized||a).apply(null,arguments)}}})();MODULE="browserhttp";(function(a){a.get=function(a,b){var d=new XMLHttpRequest;d.onload=function(){200==d.status?b(null,d.responseText):b(d.status)};d.onerror=function(){b("Error")};d.open("GET",a.path,!0);d.send()}})("undefined"===typeof exports?this[MODULE]={}:exports);MODULE="audio";
(function(a){var g=util.CallbackQueue;a.WebkitAudio=function(){"webkitAudioContext"in window&&(this.audio=new webkitAudioContext);this.buffers={}};a.WebkitAudio.prototype.getBuffer=function(a){a=this.buffers[a];return a instanceof g?null:a||null};a.WebkitAudio.prototype.loadBuffer=function(a,d){if(a in this.buffers){var h=this.buffers[a];h instanceof g?h.add(d):d(this.buffers[a])}else if(this.audio){var c=new g(d);this.buffers[a]=c;var m=new XMLHttpRequest;m.open("GET",a,!0);m.responseType="arraybuffer";
m.onload=function(){var d=this.audio.createBuffer(m.response,!0);this.buffers[a]=d;c.fire(d)}.bind(this);m.send()}};a.WebkitAudio.prototype.playSound=function(a,d,g,c){var m=this.audio.createBufferSource();m.buffer=a;m.connect(this.audio.destination);m.loop=d;m.gain.value=g;m.playbackRate.value=void 0===c?1:c;m.noteOn(0);return m}})("undefined"===typeof exports?this[MODULE]={}:exports);var Car=function(){this.wheelGeometry=this.bodyGeometry=null;this.root=new THREE.Object3D;this.root.useQuaternion=!0;this.bodyMesh=null;this.wheels=[];this.vehic=null;this.config={};this.sourceSkid=this.sourceWind=this.sourceTransmission=this.sourceEngine=null;this.buffersCrash=[];this.loadWithVehicle=function(a,g){this.vehic=a;this.config=a.cfg;this.loadPartsJSON(this.config.meshes.body,this.config.meshes.wheel,g)};this.loadPartsJSON=function(a,g,b){var d=new THREE.JSONLoader;async.parallel({body:function(b){d.load(a,
function(a){b(null,a)},"/a/textures")},wheel:function(a){d.load(g,function(b){a(null,b)},"/a/textures")}},function(a,c){if(a)throw a;this.bodyGeometry=c.body;this.wheelGeometry=c.wheel;this.createCar();b()}.bind(this))};this.update=function(){if(this.vehic){var a=this.vehic.body.interp;this.root.position.copy(a.pos);this.root.quaternion.copy(a.ori);for(a=0;a<this.wheels.length;++a){var g=this.wheels[a],b=this.vehic.wheels[a];g.root.position.y=g.cfg.pos[1]+b.ridePos;g.root.rotation.y=this.vehic.getWheelTurnPos(b);
g.mesh.rotation.x=b.spinPos}this.aud&&(this.sourceEngine&&(this.sourceEngine.gain.value=0.2*this.vehic.controller.output.throttle+0.4,this.sourceEngine.playbackRate.value=this.vehic.engineAngVelSmoothed/(this.config.sounds.engineRpm*Math.PI/30)),this.sourceTransmission&&(a=this.vehic.differentialAngVel/(this.config.sounds.transmissionRpm*Math.PI/30),this.sourceTransmission.gain.value=0.08*Math.min(1,a)*this.vehic.controller.output.throttle,this.sourceTransmission.playbackRate.value=a),this.sourceWind&&
(a=this.vehic.body.linVel.length()/this.config.sounds.windSpeed,this.sourceWind.gain.value=1.4*Math.min(1.4,a),this.sourceWind.playbackRate=a+0.5),this.sourceSkid&&(this.sourceSkid.gain.value=Math.log(1+0.05*this.vehic.skidLevel)),a=5.0E-6*this.vehic.getCrashNoiseLevel(),0<a&&0<this.buffersCrash.length&&this.aud.playSound(this.buffersCrash[Math.floor(Math.random()*this.buffersCrash.length)],!1,Math.log(1+a),0.99+0.02*Math.random()))}};this.createCar=function(){var a;a=Vec3FromArray(this.config.center);
var g=this.config.scale||1,b=new THREE.MeshFaceMaterial;this.bodyMesh=new THREE.Mesh(this.bodyGeometry,b);this.bodyMesh.position.copy(a).multiplyScalar(-1);this.bodyMesh.scale.set(g,g,g);this.root.add(this.bodyMesh);for(a=0;a<this.config.wheels.length;++a){var d=this.config.wheels[a],h={};h.cfg=d;h.mesh=new THREE.Mesh(this.wheelGeometry,b);h.mesh.scale.set(g,g,g);d.flip&&(h.mesh.rotation.z=Math.PI);h.root=new THREE.Object3D;h.root.position=new THREE.Vector3(d.pos[0],d.pos[1],d.pos[2]);h.root.add(h.mesh);
this.root.add(h.root);this.wheels.push(h)}if(this.aud){g=this.config.sounds;this.aud.loadBuffer(g.engine,function(a){this.sourceEngine=this.aud.playSound(a,!0,0)}.bind(this));this.aud.loadBuffer(g.transmission,function(a){this.sourceTransmission=this.aud.playSound(a,!0,0)}.bind(this));this.aud.loadBuffer(g.wind,function(a){this.sourceWind=this.aud.playSound(a,!0,0)}.bind(this));this.aud.loadBuffer(g.skid,function(a){this.sourceSkid=this.aud.playSound(a,!0,0)}.bind(this));for(b=0;b<g.crash.length;++b)this.aud.loadBuffer(g.crash[b],
function(a,b){this.buffersCrash[a]=b}.bind(this,b))}}};var SCREEN_WIDTH,SCREEN_HEIGHT,SCREEN_ASPECT,SHADOW_MAP_WIDTH=1024,SHADOW_MAP_HEIGHT=1024,KEYCODE=util.KEYCODE,PULLTOWARD=util.PULLTOWARD,Vec2=THREE.Vector2,Vec3=THREE.Vector3,Vec3FromArray=util.Vec3FromArray,stats,sceneHUD,cameraHUD,revMeter,scene,camera,debugMesh,webglRenderer,sunLight,sunLightPos,cameraMode=0,CAMERA_MODES=3,trees=[],meshCheckpoint,meshArrow,meshArrowNext,containerEl=$$("frame3d")[0],checkpointsEl=$("checkpoints"),countdownEl=$("countdown"),runTimerEl=$("timer"),twitterLinkEl=$("twitterlink"),
fullscreenLinkEl=$("fullscreenlink"),saveReplayLinkEl=$("savereplaylink"),keyDown=[],textureCube,game,car,followProgress,updateTimer=!0,lastRaceTime=0,carRecorder1,carRecorder2,replayPlayback1,replayPlayback2,aud,checkpointBuffer,sourcesTmp=[],windowHalfX=window.innerWidth/2,windowHalfY=window.innerHeight/2;document.addEventListener("mousemove",onDocumentMouseMove,!1);document.addEventListener("keydown",onDocumentKeyDown,!1);document.addEventListener("keyup",onDocumentKeyUp,!1);var lastTime=Date.now();
init();
function init(){if(!Detector.webgl){Detector.addGetWebGLMessage();var a=document.getElementsByClassName("loading")[0];a.className+=" loaded";return!1}sceneHUD=new THREE.Scene;cameraHUD=new THREE.OrthographicCamera(-SCREEN_ASPECT,SCREEN_ASPECT,-1,1,-1,1);sceneHUD.add(cameraHUD);a=new THREE.Geometry;a.vertices.push(new THREE.Vertex(new Vec3(1,0,0)));a.vertices.push(new THREE.Vertex(new Vec3(-0.1,-0.02,0)));a.vertices.push(new THREE.Vertex(new Vec3(-0.1,0.02,0)));a.faces.push(new THREE.Face3(0,1,2));
a.computeCentroids();var g=new THREE.MeshBasicMaterial;revMeter=new THREE.Mesh(a,g);revMeter.position.x=-1.5;revMeter.scale.multiplyScalar(0.4);scene=new THREE.Scene;camera=new THREE.PerspectiveCamera(75,1,0.1,1E5);camera.position.x=2;camera.position.y=2;camera.position.z=2;scene.add(camera);a=new THREE.SphereGeometry(0.2,16,8);g=new THREE.MeshBasicMaterial;debugMesh=new THREE.Mesh(a,g);scene.add(debugMesh);scene.fog=new THREE.FogExp2(14540253,0.0010);a=new THREE.AmbientLight(4482688);scene.add(a);
sunLightPos=new Vec3(0,10,-15);sunLight=new THREE.DirectionalLight(16769211);sunLight.intensity=1.3;sunLight.position.copy(sunLightPos);sunLight.castShadow=!0;sunLight.shadowCameraNear=-20;sunLight.shadowCameraFar=60;sunLight.shadowCameraLeft=-24;sunLight.shadowCameraRight=24;sunLight.shadowCameraTop=24;sunLight.shadowCameraBottom=-24;sunLight.shadowDarkness=0.4;sunLight.shadowMapWidth=SHADOW_MAP_WIDTH;sunLight.shadowMapHeight=SHADOW_MAP_HEIGHT;scene.add(sunLight);webglRenderer=new THREE.WebGLRenderer({antialias:!1});
webglRenderer.setSize(SCREEN_WIDTH,SCREEN_HEIGHT);webglRenderer.shadowMapEnabled=!0;webglRenderer.shadowMapSoft=!0;webglRenderer.autoClear=!1;onWindowResize();containerEl.appendChild(webglRenderer.domElement);fullscreenLinkEl.addEventListener("click",function(){var a=containerEl;(a.requestFullScreenWithKeys||a.webkitRequestFullScreenWithKeys||a.mozRequestFullScreenWithKeys||a.requestFullScreen||a.webkitRequestFullScreen||a.mozRequestFullScreen).bind(a)()});a=function(){_.delay(onWindowResize,1E3)};
document.addEventListener("fullscreenchange",a);document.addEventListener("mozfullscreenchange",a);document.addEventListener("webkitfullscreenchange",a);saveReplayLinkEl&&saveReplayLinkEl.addEventListener("click",function(){uploadRun()});"undefined"!=typeof Stats&&(stats=new Stats,stats.domElement.style.position="absolute",stats.domElement.style.top="0px",stats.domElement.style.zIndex=100,containerEl.appendChild(stats.domElement));textureCube=THREE.ImageUtils.loadTextureCube("/a/textures/Teide-1024/posx.jpg,/a/textures/Teide-1024/negx.jpg,/a/textures/Teide-1024/posy.jpg,/a/textures/Teide-1024/negy.jpg,/a/textures/Teide-1024/posz.jpg,/a/textures/Teide-1024/negz.jpg".split(","));
drawCube();drawCheckpoint();drawArrow();aud=new audio.WebkitAudio;aud.loadBuffer("/a/sounds/checkpoint.wav",function(a){checkpointBuffer=a});var b=new THREE.JSONLoader;game=new game.Game(browserhttp);async.parallel({track:function(a){game.setTrackConfig(TRIGGER.TRACK.CONFIG,a)},car:function(a){game.addCarConfig(TRIGGER.CAR.CONFIG,function(b,c){if(b)throw Error(b);followProgress=c;TRIGGER.RUN?(replayPlayback1=new recorder.StatePlayback(c.vehicle.controller.input,TRIGGER.RUN.INPUT),replayPlayback2=
new recorder.StatePlayback(c,TRIGGER.RUN.PROGRESS),game.sim.pubsub.subscribe("step",function(){replayPlayback1.step();replayPlayback2.step()}),replayPlayback1.pubsub.subscribe("complete",function(){checkpointsEl.innerHTML="Replay complete";updateTimer=!1})):(carRecorder1=new recorder.StateRecorder(c.vehicle.controller.input,{forward:0,back:0,left:0,right:0,handbrake:0},2),carRecorder2=new recorder.StateRecorder(c,{nextCpIndex:0,vehicle:{body:{pos:{x:3,y:3,z:3},ori:{x:3,y:3,z:3,w:3},linVel:{x:3,y:3,
z:3},angVel:{x:3,y:3,z:3}},wheels:[{spinVel:1}],engineAngVel:3}},40),game.sim.pubsub.subscribe("step",function(){carRecorder1.observe();carRecorder2.observe()}));car=new Car;car.aud=aud;car.loadWithVehicle(c.vehicle,a);c.pubsub.subscribe("advance",advanceCheckpoint)})},geomTrunk:function(a){b.load("/a/meshes/tree1a_lod2_tex_000.json",function(b){a(null,b)},"/a/textures")},geomLeaves:function(a){b.load("/a/meshes/tree1a_lod2_tex_001.json",function(b){a(null,b)},"/a/textures")}},function(a,b){if(a)throw Error(a);
drawTrack(b.track.terrain.getTile(0,0));drawTrees(b.geomTrunk,b.geomLeaves);var c=car.bodyGeometry.materials[0];c.envMap=textureCube;c.combine=THREE.MixOperation;c.reflectivity=0.1;c.wrapAround=0;c.ambient=c.color;c=car.wheelGeometry.materials[0];c.ambient=c.color;car.bodyMesh.castShadow=!0;car.bodyMesh.receiveShadow=!0;for(c=0;c<car.wheels.length;++c)car.wheels[c].mesh.castShadow=!0,car.wheels[c].mesh.receiveShadow=!0;scene.add(car.root);c=document.getElementsByClassName("loading")[0];c.className+=
" loaded";requestAnimationFrame(animate)});return!0}
function drawTrees(a,g){var b=a.materials[0];b.ambient=b.color;var d=g.materials[0];d.ambient=d.color;d.depthWrite=!1;d.transparent=!0;var h;for(h=0;h<game.track.trees.length;++h){var c=game.track.trees[h],m=new THREE.Mesh(a,b);m.castShadow=!0;m.receiveShadow=!0;m.scale.set(c.scl,c.scl,c.scl);m.position.copy(c);m.rotation.y=c.rot;scene.add(m);m=new THREE.Mesh(g,d);m.castShadow=!0;m.doubleSided=!0;m.scale.set(c.scl,c.scl,c.scl);m.position.copy(c);m.rotation.y=c.rot;scene.add(m)}}
function drawCube(){var a=THREE.ShaderUtils.lib.cube;a.uniforms.tCube.texture=textureCube;a=new THREE.ShaderMaterial({fragmentShader:a.fragmentShader,vertexShader:a.vertexShader,uniforms:a.uniforms});a=new THREE.Mesh(new THREE.CubeGeometry(1E5,1E5,1E5),a);a.geometry.faces.splice(3,1);a.flipSided=!0;a.position.set(0,-1E3,0);scene.add(a)}
function drawCheckpoint(){var a=new THREE.MeshBasicMaterial({color:1060880,blending:THREE.AdditiveBlending,transparent:1,depthWrite:!1}),g=new THREE.Geometry,b=new THREE.CylinderGeometry(6,6,0.2,32,1,!0),b=new THREE.Mesh(b,a);b.rotation.z=0.4;THREE.GeometryUtils.merge(g,b);b.rotation.y=2*Math.PI/3;THREE.GeometryUtils.merge(g,b);b.rotation.y=4*Math.PI/3;THREE.GeometryUtils.merge(g,b);meshCheckpoint=new THREE.Mesh(g,a);meshCheckpoint.doubleSided=!0;meshCheckpoint.castShadow=!0;scene.add(meshCheckpoint)}
function drawArrow(){var a=new THREE.MeshBasicMaterial({color:2121760,blending:THREE.AdditiveBlending,transparent:1,depthWrite:!1}),g=new THREE.MeshBasicMaterial({color:331781,blending:THREE.AdditiveBlending,transparent:1,depthWrite:!1}),b=new THREE.Geometry;b.vertices.push(new THREE.Vertex(new Vec3(0,0,0.6)));b.vertices.push(new THREE.Vertex(new Vec3(0.1,0,0.3)));b.vertices.push(new THREE.Vertex(new Vec3(-0.1,0,0.3)));b.vertices.push(new THREE.Vertex(new Vec3(0.1,0,-0.2)));b.vertices.push(new THREE.Vertex(new Vec3(-0.1,
0,-0.2)));b.faces.push(new THREE.Face3(0,2,1));b.faces.push(new THREE.Face4(1,2,4,3));meshArrow=new THREE.Mesh(b,a);meshArrow.position.set(0,1,-2);meshArrowNext=new THREE.Mesh(b,g);meshArrowNext.position.set(0,0,0.8);camera.add(meshArrow);meshArrow.add(meshArrowNext)}
var drawTrack=function(a){var g=a.terrain,b=new THREE.PlaneGeometry(1,1,a.size,a.size),d,h,c=0;for(h=0;h<=a.size;++h)for(d=0;d<=a.size;++d)b.vertices[c].position.x=d*g.scaleHz,b.vertices[c].position.y=h*g.scaleHz,b.vertices[c].position.z=a.heightMap[c],++c;for(c=0;c<b.faces.length;++c)d=b.faces[c].a,b.faces[c].a=b.faces[c].c,b.faces[c].c=d,d=b.faceVertexUvs[0][c][0],b.faceVertexUvs[0][c][0]=b.faceVertexUvs[0][c][2],b.faceVertexUvs[0][c][2]=d;b.computeCentroids();b.computeFaceNormals();b.computeVertexNormals();
a=THREE.ImageUtils.loadTexture("/a/textures/mayang-earth.jpg");a.wrapS=a.wrapT=THREE.RepeatWrapping;a.repeat.set(100,100);a=new THREE.MeshLambertMaterial({map:a,wrapAround:!1});a.ambient=a.color;b=new THREE.Mesh(b,a);b.position.set(0,0,0);b.rotation.x=-Math.PI/2;b.castShadow=!1;b.receiveShadow=!0;scene.add(b)};function onDocumentMouseMove(a){mouseX=0.01*(a.clientX-windowHalfX);mouseY=0.01*(a.clientY-windowHalfY)}
function keyWeCareAbout(a){return!a.shiftKey&&!a.ctrlKey&&!a.metaKey&&32<=a.keyCode&&127>=a.keyCode}function onDocumentKeyDown(a){if(keyWeCareAbout(a)){keyDown[a.keyCode]=!0;switch(a.keyCode){case KEYCODE.C:cameraMode=(cameraMode+1)%CAMERA_MODES}a.preventDefault();return!1}}function onDocumentKeyUp(a){if(keyWeCareAbout(a))return keyDown[a.keyCode]=!1,a.preventDefault(),!1}
function onWindowResize(){SCREEN_WIDTH=containerEl.clientWidth;SCREEN_HEIGHT=containerEl.clientHeight;SCREEN_ASPECT=0<SCREEN_HEIGHT?SCREEN_WIDTH/SCREEN_HEIGHT:1;webglRenderer.setSize(SCREEN_WIDTH,SCREEN_HEIGHT);camera.aspect=SCREEN_ASPECT;camera.updateProjectionMatrix()}
function animate(){var a=Date.now(),g=Math.min(0.0010*(a-lastTime),0.1);lastTime=a;var b=followProgress.nextCheckpoint(0),a=followProgress.nextCheckpoint(1);if(b){var d=2*g;meshCheckpoint.position.x=PULLTOWARD(meshCheckpoint.position.x,b.x,d);meshCheckpoint.position.y=PULLTOWARD(meshCheckpoint.position.y,b.y,d);meshCheckpoint.position.z=PULLTOWARD(meshCheckpoint.position.z,b.z,d);meshCheckpoint.rotation.y+=3*g}if(updateTimer){d=game.interpolatedRaceTime();if(0<=d)0>lastRaceTime&&(countdownEl.innerHTML=
"Go!",countdownEl.className+=" fadeout",checkpointsEl.innerHTML=followProgress.nextCpIndex+" / "+game.track.checkpoints.length),runTimerEl.innerHTML=formatRunTime(d);else{var h=Math.ceil(-d),c=Math.ceil(-lastRaceTime);h!=c&&(countdownEl.innerHTML=h)}lastRaceTime=d}TRIGGER.RUN||(d=car.vehic.controller.input,d.forward=keyDown[KEYCODE.UP]||keyDown[KEYCODE.W]?1:0,d.back=keyDown[KEYCODE.DOWN]||keyDown[KEYCODE.S]?1:0,d.left=keyDown[KEYCODE.LEFT]||keyDown[KEYCODE.A]?1:0,d.right=keyDown[KEYCODE.RIGHT]||keyDown[KEYCODE.D]?
1:0,d.handbrake=keyDown[KEYCODE.SPACE]?1:0);game.sim.tick(g);car.update();b&&(b=new Vec2(car.vehic.body.pos.x-b.x,car.vehic.body.pos.z-b.z),b=new Vec2(car.vehic.body.pos.x-meshCheckpoint.position.x,car.vehic.body.pos.z-meshCheckpoint.position.z),b=new Vec2(b.x*camera.matrixWorld.n31-b.y*camera.matrixWorld.n33,b.x*camera.matrixWorld.n11-b.y*camera.matrixWorld.n13),meshArrow.rotation.y=Math.atan2(-b.y,b.x));a&&(b=new Vec2(car.vehic.body.pos.x-a.x,car.vehic.body.pos.z-a.z),b=new Vec2(b.x*camera.matrixWorld.n31-
b.y*camera.matrixWorld.n33,b.x*camera.matrixWorld.n11-b.y*camera.matrixWorld.n13),meshArrowNext.rotation.y=Math.atan2(-b.y,b.x)-meshArrow.rotation.y);a=car.vehic.body.linVel;b=20*g;camera.quaternion.x=PULLTOWARD(camera.quaternion.x,-car.root.quaternion.z,b);camera.quaternion.y=PULLTOWARD(camera.quaternion.y,car.root.quaternion.w,b);camera.quaternion.z=PULLTOWARD(camera.quaternion.z,car.root.quaternion.x,b);camera.quaternion.w=PULLTOWARD(camera.quaternion.w,-car.root.quaternion.y,b);camera.quaternion.normalize();
switch(cameraMode){case 0:b=car.root.position.clone();b.addSelf(a.clone().multiplyScalar(0.17));b.addSelf(car.root.matrix.getColumnX().clone().multiplyScalar(0));b.addSelf(car.root.matrix.getColumnY().clone().multiplyScalar(1.2));b.addSelf(car.root.matrix.getColumnZ().clone().multiplyScalar(-2.9));g*=5;camera.position.x=PULLTOWARD(camera.position.x,b.x,g);camera.position.y=PULLTOWARD(camera.position.y,b.y,g);camera.position.z=PULLTOWARD(camera.position.z,b.z,g);camera.useQuaternion=!1;g=car.root.position.clone();
g.addSelf(car.root.matrix.getColumnY().clone().multiplyScalar(0.7));camera.lookAt(g);break;case 1:camera.useQuaternion=!0;camera.updateMatrix();camera.position.x=car.root.position.x+0.7*camera.matrix.n12;camera.position.y=car.root.position.y+0.7*camera.matrix.n22;camera.position.z=car.root.position.z+0.7*camera.matrix.n32;camera.matrix.setPosition(camera.position);break;case 2:camera.useQuaternion=!0,camera.updateMatrix(),g=new Vec3(camera.matrix.n12,camera.matrix.n22,camera.matrix.n32),a=new Vec3(camera.matrix.n11,
camera.matrix.n21,camera.matrix.n31),camera.position.add(car.root.position,g.multiplyScalar(0)),camera.position.addSelf(a.multiplyScalar(1)),camera.matrix.setPosition(camera.position)}g=camera.position.clone();g.y-=0.1;g=game.sim.collide(g);for(a=0;a<g.length;++a)camera.position.y<g[a].surfacePos.y+0.1&&(camera.position.y=g[a].surfacePos.y+0.1);sunLight.target.position.copy(car.root.position);sunLight.position.copy(car.root.position).addSelf(sunLightPos);sunLight.updateMatrixWorld();sunLight.target.updateMatrixWorld();
revMeter.rotation.z=2.5+4.5*((car.vehic.engineAngVelSmoothed-car.vehic.engineIdle)/(car.vehic.engineRedline-car.vehic.engineIdle));render();stats&&stats.update();requestAnimationFrame(animate)}function padZero(a,g){return(1E15+a+"").slice(-g)}function formatRunTime(a){var g=Math.floor(a/60),a=a-60*g,b=Math.floor(a),a=Math.floor(100*(a-b));return g+":"+padZero(b,2)+"."+padZero(a,2)}
function advanceCheckpoint(){checkpointBuffer&&aud.playSound(checkpointBuffer,!1,1,1);checkpointsEl.innerHTML=followProgress.nextCpIndex+" / "+game.track.checkpoints.length;followProgress.nextCheckpoint(0)||(updateTimer=!1,runTimerEl.className="",TRIGGER.RUN||(TRIGGER.USER_LOGGED_IN?_.delay(uploadRun,1E3):showTwitterLink()))}
function uploadRun(){var a=new FormData;a.append("user",TRIGGER.USER_LOGGED_IN);a.append("track",TRIGGER.TRACK.ID);a.append("car",TRIGGER.CAR.ID);a.append("time",JSON.stringify(followProgress.finishTime()-game.startTime));a.append("record_i",JSON.stringify(carRecorder1.serialize()));a.append("record_p",JSON.stringify(carRecorder2.serialize()));var g=new XMLHttpRequest;g.open("POST","/run/new",!0);g.onload=function(){var a=JSON.parse(g.responseText).run;twitterLinkEl.innerHTML="View stats and replay";
twitterLinkEl.href="/run/"+a;twitterLinkEl.className="visible"};g.send(a)}function showTwitterLink(){var a=["Radial!","Galvanized!","Totally slipstream!","Arboreal!","Spintastic!"],a=a[Math.floor(Math.random()*a.length)];twitterLinkEl.href=getTwitterLink("Just finished "+TRIGGER.TRACK.NAME+" with the "+TRIGGER.CAR.NAME+" in "+runTimerEl.innerHTML+". "+a+" @triggerrally");twitterLinkEl.className="visible"}
function getTwitterLink(a){return"http://twitter.com/intent/tweet?text="+encodeURIComponent(a)}function render(){webglRenderer.clear(!0,!0);webglRenderer.render(scene,camera)};
